---
- name: Search for stale switchports and create a report
  hosts: nexus9k3
  gather_facts: false
  vars:
    days_down: 20 # Number of days down to consider a port stale
    csv_destination: "{{ playbook_dir }}/stale_switchports.csv"
    headers: host,interface
    # csv_lines: 
    #   - "{{ headers }}"
    csv_lines: "{{ headers }}"

  tasks:
    - name: Issue a show interfaces on the switch
      nxos_command:
        commands:
          - 'show int | b Ethernet1/'
      register: interface_status

    - name: Split command output into per-interface blocks
      set_fact:
        interface_blocks: "{{ interface_status.stdout[0] | regex_findall('(?ms)^Ethernet\\S+.*?(?=^Ethernet\\S+|\\Z)') }}"

    # - name: Build interface flap age details
    #   set_fact:
    #     interface_flap_days: "{{ interface_flap_days | default([]) + [ {
    #       'interface': item.splitlines()[0].split(' is ')[0],
    #       'last_link_flapped': flap_value,
    #       'days_since_last_flap': flap_days
    #     } ] }}"
    #   vars:
    #     flap_value: "{{ (item.splitlines() | select('search', '^\\s*Last link flapped ') | first | default('Last link flapped unknown')) | regex_replace('^\\s*Last link flapped\\s*', '') }}"
    #     flap_weeks: "{{ flap_value | regex_search('[0-9]+week\\(s\\)') | default('0', true) | regex_replace('[^0-9]', '') | default('0', true) | int }}"
    #     flap_day_count: "{{ flap_value | regex_search('[0-9]+day\\(s\\)') | default('0', true) | regex_replace('[^0-9]', '') | default('0', true) | int }}"
    #     flap_days: "{{ 0 if flap_value in ['never', 'unknown'] else ((flap_weeks | int * 7) + (flap_day_count | int)) }}"
    #   loop: "{{ interface_blocks }}"

    # - name: Display days since last link flap per interface
    #   debug:
    #     msg: "{{ item.interface }} last flapped {{ item.last_link_flapped }} ({{ item.days_since_last_flap }} day(s))"
    #   loop: "{{ interface_flap_days }}"
    #   loop_control:
    #     label: "{{ item.interface }}"

    # - name: Build list of dictionaries for each interface block
    #   set_fact:
    #     interface_details: "{{ interface_details | default([]) + [ {
    #       'interface': item.splitlines()[0].split(' is ')[0],
    #       'status_line': item.splitlines()[0],
    #       'block_lines': item.splitlines(),
    #       'raw_block': item
    #     } ] }}"
    #   loop: "{{ interface_blocks }}"

    # - name: Display parsed interface dictionaries
    #   debug:
    #     var: interface_details

    # - name: Print out all interface names that are "Link not connected"
    #   debug:
    #     msg: "Interface {{ item.splitlines()[0].split(' is ')[0] }} is Link not connected"
    #   loop: "{{ interface_blocks }}"
    #   when: 
    #     - "'Link not connected' in item" # Interface is down
    #     - "'Port mode is access' in item" # Interface is not a trunk
    #     - "'Reserved' not in item" # Interface is not reserved
    #     # - "'BW 1000000' in item" # Interface is 1G, not 10G or higher

    

    - name: Save CSV headers
      ansible.builtin.lineinfile:
        dest: "{{ csv_destination }}"
        line: "{{ headers }}"
        create: true
        state: present
      delegate_to: localhost
      run_once: true

    - name: Save line to CSV file
      ansible.builtin.lineinfile:
        dest: "{{ csv_destination }}"
        line: "{{ inventory_hostname }},{{ item.splitlines()[0].split(' is ')[0] }}"
        create: true
        state: present
      delegate_to: localhost
      vars:
        flap_value: "{{ (item.splitlines() | select('search', '^\\s*Last link flapped ') | first | default('Last link flapped unknown')) | regex_replace('^\\s*Last link flapped\\s*', '') }}"
        flap_weeks: "{{ flap_value | regex_search('[0-9]+week\\(s\\)') | default('0', true) | regex_replace('[^0-9]', '') | default('0', true) | int }}"
        flap_day_count: "{{ flap_value | regex_search('[0-9]+day\\(s\\)') | default('0', true) | regex_replace('[^0-9]', '') | default('0', true) | int }}"
        flap_days: "{{ 0 if flap_value in ['never', 'unknown'] else ((flap_weeks | int * 7) + (flap_day_count | int)) }}"
      loop: "{{ interface_blocks }}"
      when: 
        - flap_days | int > days_down | int # checking to see if it's been down long enough
        # - "'Link not connected' in item" # Interface is down
        - "'Port mode is access' in item" # Interface is not a trunk
        - "'Reserved' not in item" # Interface is not reserved
        # - "'BW 1000000' in item" # Interface is 1G, not 10G or higher

    # - name: Create a big variable to write to the file at once
    #   set_fact:
    #     csv_lines: "{{ csv_lines  + '\n' + [ inventory_hostname + ',' + item.splitlines()[0].split(' is ')[0] ] }}"
    #   loop: "{{ interface_blocks }}"
    #   when: 
    #     - "'Link not connected' in item" # Interface is down
    #     - "'Port mode is access' in item" # Interface is not a trunk
    #     - "'Reserved' not in item" # Interface is not reserved
    #     # - "'BW 1000000' in item" # Interface is 1G, not 10G or higher

    # - name: Save the matching port entry to a file
    #   copy:
    #     content: "{{ csv_lines }}"
    #     dest: "{{ csv_destination }}"

    - name: Display contents of csv_destination
      debug:
        msg: "Contents of {{ csv_destination }}:\n{{ lookup('file', csv_destination) }}"